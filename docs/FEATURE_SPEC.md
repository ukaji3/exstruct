# Feature Spec for AI Agent (Phase-by-Phase)

本ドキュメントは AI エージェント向けに、段階的に実装を進めるための仕様メモです。外部公開前のローカル環境で開発することを前提とします。

---

## 0. 直近で完了済みの仕様

- JSON 出力はデフォルトでコンパクト（indent なし）。`pretty=True` または CLI `--pretty` でインデント 2 のプリティ出力を選択可能。
- `tables` フィールドは `table_candidates` にリネーム済み。JSON スキーマ変更に注意。

---

## 1. テーブル検出の精度向上（段階実装）

目標: レイアウト枠線を誤検知せず、実際の小さな表を見逃さない。

1-1. ヘッダ検知の導入

- 先頭 1–2 行の文字種・長さ・数値混在率からヘッダ候補を特定。
- ヘッダ候補がある矩形はスコアを上げ、ヘッダが無い大枠はスコアを下げる。

1-2. 矩形スコアリングの統合

- 既存の密度・包含判定に加えて「ヘッダスコア」「行/列の均一性スコア」を組み合わせ、一定スコア未満は除外。
- 閾値は定数で定義し、調整しやすくする（例: `TABLE_SCORE_THRESHOLD`）。

1-3. サンプルでのリグレッション確認

- `sample/sample_table.xlsx` を用い、JSON 出力が誤検知を減らしつつ正例（B7:K17, K36:M42 など）を維持することを手動で確認。
- 自動テストにフィクスチャを追加できる場合は、表の正例/負例を入れる。

---

## 2. COM 依存の安定化

目標: Excel COM が無い／不安定でもプロセスがクラッシュしないこと。

- xlwings 呼び出し箇所で例外を握り、セル＋テーブル検出のみのフォールバックに確実に落とす。
- テストで COM なし環境を検知したら `skip` または `xfail`（すでに一部実装済みだが、残っていれば適用）。
- CLI でも COM 例外時はメッセージを出して終了コード 0/1 を仕様に沿って返す。

---

## 3. 今後のオプション（検討メモ）

- 表検出スコアリングの閾値を CLI/環境変数で調整可能にする。
- 出力モード（light/standard/verbose）に応じてテーブル候補数を制限するオプション。
- RAG 連携用に JSON スキーマのサマリ／サンプル生成コマンドを追加。

---

## 実装方針

- 各ステップ完了ごとにテスト追加または既存フィクスチャで手動確認。
- 短い定数・関数分割でスコアリングの調整をしやすくする。
- 外部公開前なので、破壊的変更は適宜コメント・メモに残す。
