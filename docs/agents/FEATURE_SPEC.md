# Feature Spec for AI Agent (Phase-by-Phase)

本ドキュメントは AI エージェント向けに、段階的に実装を進めるための仕様メモです。

---

## セル結合データのコンテキスト量圧縮

- 現状の `merged_cells` がコンテキスト量を非常に多く持っているため、データ構造の見直しで圧縮する
- `rows` と `merged_cells` でセル値を重複して持っているため、出力時に `rows` 側の結合セル値を落とす運用を検討する

### 仕様（v1.1 予定）

- `merged_cells` を **schema + items** 形式へ変更して冗長なキーを削減する
- 結合セルの値は `merged_cells` に集約し、`rows` 側に保持するかはフラグで切替可能にする

#### merged_cells の新フォーマット（例）

```json
{
  "merged_cells": {
    "schema": ["r1", "c1", "r2", "c2", "v"],
    "items": [
      [1, 0, 2, 1, "A1-B2 merged"],
      [3, 4, 3, 6, "merged value"]
    ]
  }
}
```

- `r1/c1/r2/c2` は従来同様の座標（row: 1-based, col: 0-based）
- `v` は結合セルの代表値（セル値がない場合でも `" "` を出力する）

#### rows 側の結合セル値の扱い

- 新しいフラグ `include_merged_values_in_rows: bool` を導入
- `True` の場合は互換モード（従来どおり `rows` に結合セル値を残す）
- `False` の場合は `rows` から結合セル値を排除し、`merged_cells` のみで値を保持

#### 互換性

- デフォルトは `True` として破壊的変更を回避
- 将来的にデフォルト切替の可能性があるため、出力仕様に明記する

---

## 今後のオプション検討メモ

- 表検知スコアリングの閾値を CLI/環境変数で調整可能にする
- 出力モード（light/standard/verbose）に応じてテーブル候補数を制限するオプション

---

## 実装方針

- 小さなステップごとにテスト追加、または既存フィクスチャで手動確認
- 短い関数・責務分割でスコアリング調整をしやすくする
- 外部公開前なので、破壊的変更はコメントや仕様に明示して段階的に移行する
