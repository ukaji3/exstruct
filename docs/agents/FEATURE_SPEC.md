# Feature Spec for AI Agent (Phase-by-Phase)

本ドキュメントは AI エージェント向けに、段階的に実装を進めるための仕様メモです。外部公開前のローカル環境で開発することを前提とします。

---

## リファクタリング案

- PrintAreaView 判定と出力フラグの分散

  - 事象: shapes/charts のフィルタとサイズ出力フラグが io と engine の両方に散在し、呼び出し側の引数も増えてきた。
  - 対策案: PrintAreaView のビルドをサービスクラス/モジュールに切り出し、(include_shapes, include_charts, include_shape_size, include_chart_size) を一つの設定オブジェクトにまとめる。エンジンからは mode に基づくプリセットを渡すだけにする。

- ドキュメントとコードの同期コスト

  - 事象: DATA_MODEL/README/api が手書きで分散している。モデル更新時の漏れリスクが高い。
  - 対策案: pydantic モデルから md 断片を自動生成するスクリプトを用意し、mkdocs ビルド前に挿入するワークフローを追加。少なくともモデルのフィールドリストと型は自動抽出する。

- テストの環境依存 (COM/pypdfium2)

  - 事象: Windows+Excel 前提のテストと openpyxl の軽量テストが混在。SKIP_COM_TESTS などで制御しているが、構造が見えにくい。
  - 対策案: tests/com/ と tests/nocom/ のようにディレクトリを分け、pytest マーカーで実行条件を明示する。CI マトリクスで Windows/非 Windows を分けて回すことを前提にしておく。

- 例外/警告のポリシー未統一

  - 事象: 印刷範囲が無い場合などの振る舞いが静かで、ユーザーが気づきにくい。場所により RuntimeError/ValueError/警告などが混在。
  - 対策案: シナリオ別のポリシーを決めて、エラー種別とメッセージを整理する。特に export_print_areas_as やレンダリング周りは明文化して共通化する。

- リソース取得の冗長性
  - 事象: 印刷範囲取得が openpyxl→COM のようにロジックがファイル内に分散。似たパターンが他にもある。
  - 対策案: 抽出パイプラインをステップ化し、各ステップ（cells, tables, shapes, charts, print_areas）の実装をモジュール単位で揃える。パイプライン定義を 1 か所にまとめるとモード追加や切替が容易になる。

## 今後のオプション（検討メモ）

- 表検出スコアリングの閾値を CLI/環境変数で調整可能にする。
- 出力モード（light/standard/verbose）に応じてテーブル候補数を制限するオプション。
- RAG 連携用に JSON スキーマのサマリ／サンプル生成コマンドを追加。

---

## 実装方針

- 各ステップ完了ごとにテスト追加または既存フィクスチャで手動確認。
- 短い定数・関数分割でスコアリングの調整をしやすくする。
- 外部公開前なので、破壊的変更は適宜コメント・メモに残す。
