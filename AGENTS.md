# ExStruct AI Agents Guide

ExStruct プロジェクトでは、AI（Codex / ChatGPT）を開発プロセスに組み込み、  
高い品質を維持しつつ迅速に機能実装・改善を行うことを目的としています。

本ドキュメントは、AI エージェントが ExStruct を開発する際に守るべき  
**役割・責務・行動規範・コード品質基準・成果物仕様** を定義します。

AI（Codex）は以下の項目を必ず遵守してください。

---

# 1. AI エージェントの役割

AI は次の役割を担います：

1. **型安全で保守性の高いコードの自動生成**
2. **複雑なロジックの分解と補助**
3. **仕様書・設計資料の生成**
4. **既存コードの改善とリファクタリング提案**
5. **mypy / Ruff エラーの解消支援**
6. **テストコード生成（必要に応じて）**

AI はあくまで **実装補助者** であり、  
プロジェクトの設計トレースと品質基準の遵守が求められます。

---

# 2. AI の遵守すべきコーディング基準

AI は必ず次のルールに従ってコードを生成してください。

### 2.1 型ヒント必須（mypy strict 準拠）

- 全関数・メソッドに引数・戻り値の型を必ず付与する
- `Any` は外部ライブラリ境界のみで使用可（xlwings, pandas 等）

### 2.2 Pydantic BaseModel を返すこと

- 辞書やタプルを返さない
- すべての「構造化データ」は Pydantic モデルによって表現する

### 2.3 1 関数 = 1 責務

- 複雑度（C90）は 12 を超えない
- 必要なら AI が自動的に関数分割して良い

### 2.4 import の順序

```

1. 標準ライブラリ
2. サードパーティ
3. exstruct 内のモジュール

```

### 2.5 Docstring（Google スタイル）

関数・クラスには必ず Docstring を付ける。

### 2.6 外部ライブラリの内部構造に依存しない

- xlwings / pandas / numpy などは型を推測しない
- エンティティは境界層で Any として受け取り、内部で Pydantic に正規化する

---

# 3. AI が生成するコードの品質基準

生成コードは以下を満たさなければならない：

### ✔ mypy strict モードでエラー 0

### ✔ Ruff (E, W, F, I, B, UP, N, C90) でエラー 0

### ✔ 循環依存なし

### ✔ 責務の分割が適切

### ✔ Pydantic モデルに準拠したデータ構造

また、AI は必要に応じて以下のように振る舞う：

- 関数が複雑 → 自動で分割提案
- モデル不足 → 自動でモデルを提案
- import ゆらぎ → 自動で整理
- 不十分な docstring → 自動で改善

---

# 4. AI が書いてはいけないコード（禁止事項）

AI は以下のコードを書いてはいけません。

### ❌ 大規模・単一関数（God Function）

### ❌ 神クラス（God Object）

### ❌ 無駄なネスト・深い条件分岐

### ❌ 辞書返却・タプル返却（Pydantic モデル必須）

### ❌ xlwings や pandas の内部型に依存するコード

### ❌ import が未整理のコード

### ❌ テスト不能な副作用だらけの関数

AI は必要であれば **禁止事項を回避するためにリファクタリングしてもよい**。

---

# 5. AI に依頼するときの標準プロンプト（Developer Prompt）

AI に実装依頼する際は、以下のフォーマットが推奨されます。

```

あなたは ExStruct のコア開発エンジニアです。
mypy strict + Ruff check を完全に通過するコードのみ生成してください。

遵守事項：

- 型ヒント完全
- 境界は BaseModel、内部は dataclass を返す
- 1 関数 = 1 責務
- import 順序厳守
- Google スタイルの docstring
- 外部ライブラリ（xlwings, pandas）は Any 扱い
- 複雑度を抑えること
- 必要に応じて補助関数を追加して良い

出力は Python コードのみ。

```

---

# 6. AI にエラー修正を依頼する際のルール

mypy / Ruff のエラーが出た場合、AI への指示は次のテンプレートを使用します：

```

以下は mypy / Ruff のエラーメッセージです。
すべてのエラーが解消されるようにコードを修正してください。

<エラー全文>

```

AI は差分修正タスクが得意なため、
この方式が最も効率的かつ正確です。

---

# 7. AI の責務外（人間が担当する領域）

AI は以下の領域は担当しません。人間が判断します。

- 仕様決定（ExStruct の拡張方向）
- 公開 API 設計（break change の判断）
- ディレクトリ構造の大規模再編
- セキュリティ・ライセンス判断

ただし、AI は**提案はしてよい**。

---

# 8. AI を開発パイプラインと組み合わせる例

推奨フロー：

1. 人間：仕様を記述
2. AI：コード生成（テンプレート＋ガイドラインに従う）
3. 自動：`mypy strict` チェック
4. 自動：`ruff check --fix`
5. AI：エラー出たら修正
6. 人間：レビューしてマージ

このサイクルにより **高速 & 高品質の開発が可能** になります。

---

# 9. 最終目標

AI エージェントが ExStruct のコードを書く場合でも：

- バグのない型安全なコード
- 一貫したコーディングスタイル
- 仕様の誤解を最小化した実装
- 人間が安心してレビューできるコード

を常に提供できるようにする。

この AGENTS ガイドラインは
**Codex / ChatGPT を“チームメンバー”として扱うための基盤** です。

---

# 10. 各種仕様の確認

AI エージェントは必要に応じて以下のドキュメントを参照して ExStruct の開発をする

- 処理アーキテクチャ: `docs/architecture/pipeline.md`
- プロジェクトアーキテクチャ: `docs/contributors/architecture.md`
- コーディングガイドライン: `docs/agents/CODING_GUIDELINES.md`
- データモデル: `docs/agents/DATA_MODEL.md`
- タスク: `docs/agents/TASKS.md`

**以上。AI はこのガイドラインに従って ExStruct の開発に参加してください。**
